<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisador de Melodia</title>
  <script src="https://cdn.jsdelivr.net/npm/pitchfinder@2.3.2/dist/pitchfinder.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #output { margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>
  <h1>Analisador de Melodia</h1>
  <p>Cante ou toque uma melodia e veja as notas e a tonalidade!</p>
  <button id="recordBtn">Gravar</button>
  <button id="stopBtn" disabled>Parar</button>
  <div id="output"></div>

  <script>
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const output = document.getElementById('output');
    let audioContext, analyser, stream, notes = [];

    // Mapeamento de frequências para notas musicais
    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    function frequencyToNote(freq) {
      if (freq < 20 || freq > 2000) return null; // Faixa audível
      const noteNum = 12 * (Math.log2(freq / 440)) + 49;
      const noteIndex = Math.round(noteNum) % 12;
      const octave = Math.floor((noteNum + 8) / 12);
      return { note: noteNames[noteIndex], octave };
    }

    // Estimar tonalidade (simplificado)
    function estimateKey(notes) {
      if (!notes.length) return 'Desconhecida';
      const noteCounts = {};
      notes.forEach(n => {
        noteCounts[n.note] = (noteCounts[n.note] || 0) + 1;
      });
      const sortedNotes = Object.keys(noteCounts).sort((a, b) => noteCounts[b] - noteCounts[a]);
      const majorKeys = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'F', 'Bb', 'Eb', 'Ab'];
      const minorKeys = ['A', 'E', 'B', 'F#', 'C#', 'G#', 'D#', 'A#', 'D', 'G', 'C', 'F'];
      return sortedNotes[0] + ' maior ou ' + minorKeys[majorKeys.indexOf(sortedNotes[0])] + ' menor';
    }

    // Iniciar gravação e análise
    async function startRecording() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 2048;
        const pitchFinder = Pitchfinder.YIN();
        notes = [];

        recordBtn.disabled = true;
        stopBtn.disabled = false;
        output.textContent = 'Gravando... Cante ou toque!';

        // Analisar áudio em tempo real
        function analyze() {
          const buffer = new Float32Array(analyser.fftSize);
          analyser.getFloatTimeDomainData(buffer);
          const pitch = pitchFinder(buffer);
          if (pitch) {
            const note = frequencyToNote(pitch);
            if (note && (!notes.length || notes[notes.length - 1].note !== note.note)) {
              notes.push(note);
              output.textContent = `Nota atual: ${note.note}${note.octave} | Gravando...`;
            }
          }
          if (!stopBtn.disabled) requestAnimationFrame(analyze);
        }
        analyze();
      } catch (err) {
        output.textContent = 'Erro ao acessar o microfone: ' + err.message;
      }
    }

    // Parar gravação e exibir resultados
    function stopRecording() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        audioContext.close();
      }
      recordBtn.disabled = false;
      stopBtn.disabled = true;

      if (notes.length) {
        const noteSequence = notes.map(n => `${n.note}${n.octave}`).join(' -> ');
        const key = estimateKey(notes);
        output.innerHTML = `<strong>Sequência de notas:</strong> ${noteSequence}<br><strong>Tonalidade estimada:</strong> ${key}`;
      } else {
        output.textContent = 'Nenhuma nota detectada. Tente novamente!';
      }
    }

    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
  </script>
</body>
</html>
