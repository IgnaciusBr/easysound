<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Analisador de Notas Musicais</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background-color: #f2f2f2;
    }
    button {
      font-size: 18px;
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
    }
    #results {
      margin-top: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: inline-block;
    }
    h1 {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <h1>ðŸŽµ Analisador de Cantarolado / Trecho Musical</h1>
  <button id="start">Gravar</button>
  <button id="stop" disabled>Parar</button>

  <div id="results">
    <p><strong>Notas Detectadas:</strong> <span id="notes">-</span></p>
    <p><strong>Tonalidade Estimada:</strong> <span id="key">-</span></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tonal/browser/tonal.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pitchfinder@1.3.2/dist/pitchfinder.min.js"></script>
  <script>
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const notesSpan = document.getElementById('notes');
    const keySpan = document.getElementById('key');

    let audioContext, source, processor;
    let detectedNotes = [];

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      source = audioContext.createMediaStreamSource(stream);
      processor = audioContext.createScriptProcessor(2048, 1, 1);

      const pitchDetector = Pitchfinder.YIN();
      detectedNotes = [];

      processor.onaudioprocess = (event) => {
        const input = event.inputBuffer.getChannelData(0);
        const pitch = pitchDetector(input);

        if (pitch) {
          const midi = 69 + 12 * Math.log2(pitch / 440);
          const note = Tonal.Midi.midiToNoteName(Math.round(midi));
          if (!detectedNotes.length || detectedNotes[detectedNotes.length - 1] !== note) {
            detectedNotes.push(note);
          }
        }
      };

      source.connect(processor);
      processor.connect(audioContext.destination);

      startBtn.disabled = true;
      stopBtn.disabled = false;
      notesSpan.textContent = '-';
      keySpan.textContent = '-';
    };

    stopBtn.onclick = () => {
      processor.disconnect();
      source.disconnect();
      audioContext.close();

      startBtn.disabled = false;
      stopBtn.disabled = true;

      const cleanedNotes = detectedNotes;
      notesSpan.textContent = cleanedNotes.join(', ');

      const pitchSet = Tonal.PitchSet.chromatic(cleanedNotes);
      const detectedKey = Tonal.Key.detect(pitchSet)[0] || 'Indefinida';

      keySpan.textContent = detectedKey;
    };
  </script>
</body>
</html>
